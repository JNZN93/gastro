<div class="offers-container">
  <!-- Header -->
  <div class="offers-header">
    <div class="header-left">
      <button class="back-btn" (click)="goBackToAdmin()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        Zurück
      </button>
      <h1 class="offers-title">
        <svg class="offers-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <text x="12" y="16" text-anchor="middle" font-size="16" font-weight="bold" stroke="currentColor" fill="currentColor">%</text>
        </svg>
        Angebotsverwaltung
      </h1>
    </div>
    <button class="create-offer-btn" (click)="toggleCreateForm()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <text x="12" y="16" text-anchor="middle" font-size="16" font-weight="bold" stroke="currentColor" fill="currentColor">%</text>
      </svg>
      Neues Angebot erstellen
    </button>
  </div>

  <!-- Create Offer Form -->
  @if (showCreateForm) {
  <div class="create-offer-form">
    <h2>Neues Angebot erstellen</h2>
    <form [formGroup]="createOfferForm" (ngSubmit)="onSubmitCreateOffer()">
      <div class="form-row">
        <div class="form-group">
          <label for="name">Angebotsname *</label>
          <input type="text" id="name" formControlName="name" placeholder="z.B. Sommerschlussverkauf 2025">
        </div>
        <div class="form-group">
          <label for="description">Beschreibung *</label>
          <textarea id="description" formControlName="description" placeholder="Beschreibung des Angebots"></textarea>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="offer_type">Angebotstyp *</label>
          <select id="offer_type" formControlName="offer_type">
            <option value="fixed_amount">Fester Rabattbetrag</option>
            <option value="percentage">Prozentualer Rabatt</option>
            <option value="buy_x_get_y">Kauf X bekomme Y</option>
          </select>
        </div>
        <div class="form-group">
          <label for="discount_percentage" *ngIf="createOfferForm.get('offer_type')?.value === 'percentage'">Rabatt in %</label>
          <label for="discount_amount" *ngIf="createOfferForm.get('offer_type')?.value === 'fixed_amount'">Rabatt in €</label>
          <input 
            type="number" 
            [id]="createOfferForm.get('offer_type')?.value === 'percentage' ? 'discount_percentage' : 'discount_amount'"
            [formControlName]="createOfferForm.get('offer_type')?.value === 'percentage' ? 'discount_percentage' : 'discount_amount'"
            [placeholder]="createOfferForm.get('offer_type')?.value === 'percentage' ? '20' : '10.00'"
            step="0.01"
            min="0"
            [max]="createOfferForm.get('offer_type')?.value === 'percentage' ? '100' : null">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="start_date">Startdatum *</label>
          <input type="date" id="start_date" formControlName="start_date">
        </div>
        <div class="form-group">
          <label for="end_date">Enddatum *</label>
          <input type="date" id="end_date" formControlName="end_date">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" formControlName="is_active">
            <span class="checkmark"></span>
            Angebot ist aktiv
          </label>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="toggleCreateForm()">Abbrechen</button>
        <button type="submit" class="btn-primary" [disabled]="!createOfferForm.valid">Angebot erstellen</button>
      </div>
    </form>
  </div>
  }

  <!-- Loading State -->
  @if (loading) {
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Lade Angebote...</p>
  </div>
  }

  <!-- Offers List -->
  @if (!loading && offers.length > 0) {
  <div class="offers-list">
    @for (offer of offers; track offer.id) {
    <div class="offer-card" [class]="getStatusClass(offer)">
      <div class="offer-header">
        <div class="offer-info">
          <h3 class="offer-name">{{ offer.name }}</h3>
          <p class="offer-description">{{ offer.description }}</p>
          <div class="offer-meta">
            <span class="offer-type">{{ getOfferTypeLabel(offer.offer_type) }}</span>
            <span class="offer-discount">{{ getDiscountDisplay(offer) }}</span>
            <span class="offer-dates">
              {{ offer.start_date | date:'dd.MM.yyyy' }} - {{ offer.end_date | date:'dd.MM.yyyy' }}
            </span>
          </div>
        </div>
        <div class="offer-actions">
          <button class="btn-icon" (click)="toggleAddProductForm(offer)" title="Produkt hinzufügen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
          </button>
          <!-- Flyer page selector -->
          <label class="flyer-page-select" [attr.aria-label]="'Flyer-Seite wählen für ' + offer.name">
            <select [value]="selectedFlyerPageIndexByOfferId[offer.id!] || 0" (change)="onFlyerPageChange(offer, $event)">
              @for (p of [].constructor(getFlyerPageCount(offer)); let i = $index; track i) {
              <option [value]="i">Seite {{ i + 1 }}</option>
              }
            </select>
          </label>
          <button class="btn-icon" (click)="openFlyer(offer)" title="Flyer öffnen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v4H4V4zm0 6h10v10H4V10zm12 6h4v4h-4v-4z"/>
            </svg>
          </button>
          <button class="btn-icon delete" (click)="deleteOffer(offer.id!)" title="Angebot löschen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Products List -->
      @if (offer.products && offer.products.length > 0) {
      <div class="products-section" [class.expanded]="offer.isProductsExpanded">
        <div class="products-header" (click)="toggleProductsSection(offer)">
          <h4>Produkte im Angebot ({{ offer.products.length }})</h4>
          <div class="expand-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" [class.rotated]="offer.isProductsExpanded">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
        </div>
        <div class="products-content">
          <div class="products-list">
            @for (product of offer.products; track product.product_id + '_' + product.article_number) {
            <div class="product-item">
            <div class="product-main-info">
              <div class="product-image-section">
                @if (product.main_image_url) {
                <img class="product-detail-image" 
                     [src]="product.main_image_url" 
                     [alt]="product.article_text"
                     (click)="onProductImageClick(product)"
                     (error)="onImageError($event)">
                } @else {
                <div class="product-detail-placeholder" (click)="onProductImageClick(product)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2z"/>
                  </svg>
                </div>
                }
              </div>
              <div class="product-content-right">
                <div class="product-header">
                  <h5 class="product-name">{{ product.article_text }}</h5>
                  <div class="product-badges">
                    @if (product.category) {
                    <span class="product-category">{{ product.category }}</span>
                    }
                    @if (product.article_notes) {
                    <span class="product-notes">{{ product.article_notes }}</span>
                    }
                  </div>
                </div>
                
                <div class="product-details-grid">
                <div class="detail-item">
                  <span class="detail-label">Artikelnummer:</span>
                  <span class="detail-value">{{ product.article_number }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Produkt-ID:</span>
                  <span class="detail-value">{{ product.product_id }}</span>
                </div>
                @if (product.ean) {
                <div class="detail-item">
                  <span class="detail-label">EAN:</span>
                  <span class="detail-value">{{ product.ean }}</span>
                </div>
                }
                @if (product.unit) {
                <div class="detail-item">
                  <span class="detail-label">Einheit:</span>
                  <span class="detail-value">{{ product.unit }}</span>
                </div>
                }
              </div>
            </div>
            </div>
            <div class="product-pricing-section">
              <div class="price-display">
                @if (product.use_offer_price && product.offer_price) {
                <div class="offer-price-container">
                  <span class="price-label">Angebotspreis:</span>
                  <span class="product-price">€{{ product.offer_price }}</span>
                </div>
                }
                @if (product.sale_price) {
                <div class="original-price-container">
                  <span class="price-label">Ursprungspreis:</span>
                  <span class="product-original-price">€{{ product.sale_price }}</span>
                </div>
                }
                @if (product.cost_price) {
                <div class="cost-price-container">
                  <span class="price-label">Einkaufspreis:</span>
                  <span class="product-cost-price">€{{ product.cost_price }}</span>
                </div>
                }
              </div>
            </div>

            <div class="product-actions">
              @if (product.min_quantity || product.max_quantity) {
              <div class="quantity-info">
                <span class="quantity-label">Menge:</span>
                <span class="product-quantity">
                  {{ product.min_quantity || 0 }} - {{ product.max_quantity || '∞' }}
                </span>
              </div>
              }
              <button class="btn-remove" (click)="confirmRemoveProduct(offer, product)" title="Produkt entfernen">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
          }
          </div>
        </div>
      </div>
      } @else {
      <div class="no-products">
        <p>Keine Produkte im Angebot</p>
      </div>
      }


      
    </div>
    }
  </div>
  }

  <!-- Empty State -->
  @if (!loading && offers.length === 0) {
  <div class="empty-state">
    <h3>Keine Angebote vorhanden</h3>
    <p>Erstellen Sie Ihr erstes Angebot, um mit der Verwaltung zu beginnen.</p>
    <button class="btn-primary" (click)="toggleCreateForm()">Erstes Angebot erstellen</button>
  </div>
  }

  <!-- Confirmation Modal for Product Removal -->
  @if (showRemoveProductModal) {
  <div class="modal-overlay" (click)="closeRemoveProductModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Produkt aus Angebot entfernen</h3>
        <button class="modal-close" (click)="closeRemoveProductModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div class="modal-body">
        <p>Sind Sie sicher, dass Sie das Produkt <strong>"{{ selectedProductForRemoval?.article_text || 'ID: ' + selectedProductForRemoval?.product_id }}"</strong> aus dem Angebot <strong>"{{ selectedOfferForRemoval?.name }}"</strong> entfernen möchten?</p>
        
        <div class="product-preview">
          <div class="product-info-preview">
            <span class="product-name">{{ selectedProductForRemoval?.article_text }}</span>
            <span class="product-number">{{ selectedProductForRemoval?.article_number }}</span>
            @if (selectedProductForRemoval?.offer_price) {
            <span class="product-price">€{{ selectedProductForRemoval?.offer_price }}</span>
            }
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeRemoveProductModal()">Abbrechen</button>
        <button class="btn-danger" (click)="confirmRemoveProductAction()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
          Produkt entfernen
        </button>
      </div>
    </div>
  </div>
  }
</div>

<!-- Add Product Modal -->
@if (showAddProductForm && selectedOffer) {
<div class="add-product-modal">
  <div class="add-product-modal-content">
    <div class="add-product-modal-header">
      <h2>Produkt zu Angebot hinzufügen</h2>
      <p class="offer-name">{{ selectedOffer.name }}</p>
      <button class="close-add-product-modal" (click)="closeAddProductModal()">
        <span class="material-icons">close</span>
      </button>
    </div>
    
    <div class="add-product-modal-body">
      <form [formGroup]="addProductForm" (ngSubmit)="onSubmitAddProduct()">
        <div class="product-search-section">
          <label for="modalProductSearch">Produkt suchen *</label>
          <div class="modal-search-container">
            <div class="modal-search-input-wrapper">
              <input 
                type="text" 
                id="modalProductSearch" 
                formControlName="productSearch" 
                placeholder="Artikelname oder -nummer eingeben..."
                (input)="onProductSearch()"
                (keydown)="onProductSearchKeyDown($event)"
                (focus)="onProductSearch()"
                (blur)="onProductSearchBlur()"
                [class.searching]="isSearching"
                #modalSearchInput
              >
              @if (addProductForm.get('productSearch')?.value) {
              <button type="button" (click)="clearProductSelection()" class="clear-search">
                <span class="material-icons">close</span>
              </button>
              }
            </div>
            @if (isSearching) {
            <div class="search-spinner">
              <div class="spinner"></div>
            </div>
            }
            
            <!-- Dropdown direkt unter dem Input -->
            @if (productSearchResults.length > 0 && showSearchResults) {
            <div class="modal-search-results">
              @for (product of productSearchResults; track product.id; let i = $index) {
              <div class="modal-search-result-item" 
                   [class.selected]="selectedIndex === i"
                   (click)="selectProduct(product)"
                   (mouseenter)="selectedIndex = i">
                <div class="product-info">
                  <div class="product-main">
                    <h4 class="product-title">{{ product.article_text }}</h4>
                    <p class="product-number">Art.-Nr: {{ product.article_number }}</p>
                    @if (product.category) {
                    <span class="product-category">{{ product.category }}</span>
                    }
                  </div>
                  <div class="product-pricing">
                    @if (product.sale_price) {
                    <span class="product-price">VK: €{{ product.sale_price }}</span>
                    } @else if (product.gross_price) {
                    <span class="product-price">VK: €{{ product.gross_price }}</span>
                    }
                    @if (product.cost_price) {
                    <span class="cost-price" title="EK-Preis: €{{ product.cost_price }}">EK: €{{ product.cost_price }}</span>
                    }
                    @if (product.ean) {
                    <span class="product-ean">EAN: {{ product.ean }}</span>
                    }
                  </div>
                </div>
              </div>
              }
            </div>
            } @else if (addProductForm.get('productSearch')?.value && addProductForm.get('productSearch')?.value.length >= 3 && !isSearching && !selectedProduct) {
            <div class="modal-no-results">
              <p>Keine Artikel für "{{ addProductForm.get('productSearch')?.value }}" gefunden.</p>
            </div>
            } @else if (addProductForm.get('productSearch')?.value && addProductForm.get('productSearch')?.value.length < 3 && !isSearching && !selectedProduct) {
            <div class="modal-no-results">
              <p>Geben Sie mindestens 3 Zeichen ein, um Artikel zu finden.</p>
            </div>
            }
          </div>
          
          @if (selectedProduct) {
          <div class="modal-selected-product">
            <span class="selected-label">Ausgewähltes Produkt:</span>
            <div class="selected-info">
              <strong>{{ selectedProduct.article_text }}</strong>
              <span>{{ selectedProduct.article_number }}</span>
              <span class="selected-category">{{ selectedProduct.category }}</span>
            </div>
          </div>
          }
        </div>

        <div class="product-details-section">
          <div class="form-row">
            <div class="form-group">
              <label for="modalOfferPrice">Angebotspreis (optional)</label>
              <input type="number" id="modalOfferPrice" formControlName="offerPrice" placeholder="75.00" step="0.01" min="0">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="modalMinQuantity">Mindestmenge (optional)</label>
              <input type="number" id="modalMinQuantity" formControlName="minQuantity" placeholder="1" min="1">
            </div>
            <div class="form-group">
              <label for="modalMaxQuantity">Maximalmenge (optional)</label>
              <input type="number" id="modalMaxQuantity" formControlName="maxQuantity" placeholder="10" min="1">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="useOfferPrice">
                <span class="checkmark"></span>
                Direkten Angebotspreis verwenden
              </label>
            </div>
          </div>
        </div>

        <div class="modal-form-actions">
          <button type="button" class="btn-secondary" (click)="closeAddProductModal()">Abbrechen</button>
          <button type="submit" class="btn-primary" [disabled]="!addProductForm.valid || !selectedProduct">Produkt hinzufügen</button>
        </div>
      </form>
    </div>
  </div>
</div>
}
