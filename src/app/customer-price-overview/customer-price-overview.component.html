<div class="customer-price-overview-container">
  <div class="header">
    <h1>Kundenpreise Übersicht</h1>
    <p>Preise gruppiert nach Artikel</p>
  </div>

  <!-- Filter und Suche -->
  <div class="filters">
    <div class="search-container">
      <input 
        type="text" 
        [(ngModel)]="searchTerm" 
        placeholder="Suchbegriff eingeben (min. 3 Zeichen) - Artikel-ID, Beschreibung, Kunde oder Preis..." 
        class="search-input"
      />
      <button *ngIf="searchTerm" (click)="searchTerm = ''" class="clear-search-btn" title="Suche löschen">
        <i class="bi bi-x"></i>
      </button>
    </div>
    

    <button (click)="refreshData()" class="refresh-btn" [disabled]="loading">
      <i class="bi bi-arrow-clockwise"></i>
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Lade Kundenpreise...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <p class="error-message">{{ error }}</p>
    <button (click)="refreshData()" class="retry-btn">Erneut versuchen</button>
  </div>

  <!-- Suchstatus -->
  <div *ngIf="isSearching && !loading && !error" class="search-status">
    <span class="search-info">
      <i class="bi bi-search"></i>
      {{ filteredProductOverviews.length }} von {{ productOverviews.length }} Artikeln gefunden
      <span *ngIf="searchTerm">für "{{ searchTerm }}"</span>
    </span>
    <button (click)="clearSearch()" class="clear-all-btn">
      <i class="bi bi-x-circle"></i>
      Alle Filter löschen
    </button>
  </div>
  
  <!-- Hinweis wenn keine Suche aktiv ist -->
  <div *ngIf="!isSearching && !loading && !error && productOverviews.length > 0" class="search-hint">
    <span class="hint-info">
      <i class="bi bi-info-circle"></i>
      {{ productOverviews.length }} Artikel verfügbar - geben Sie einen Suchbegriff ein, um Ergebnisse zu sehen
    </span>
  </div>

  <!-- Daten Tabelle -->
  <div *ngIf="!loading && !error && filteredProductOverviews.length > 0" class="data-container">
    <div class="summary-stats">
      <div class="stat-item">
        <div class="stat-icon">
          <i class="bi bi-box"></i>
        </div>
        <div class="stat-content">
          <span class="stat-label">Artikel</span>
          <span class="stat-value">{{ filteredProductOverviews.length }}</span>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">
          <i class="bi bi-currency-euro"></i>
        </div>
        <div class="stat-content">
          <span class="stat-label">Kundenpreise</span>
          <span class="stat-value">{{ customerPrices.length }}</span>
        </div>
      </div>
    </div>

    <div class="products-list">
      <div *ngFor="let overview of filteredProductOverviews" class="product-card">
        <div class="product-header">
          <div class="product-title-row">
            <div class="product-icon">
              <i class="bi bi-tag"></i>
            </div>
            <h3 class="product-title">{{ overview.article_text }}</h3>
            <button class="sort-toggle-btn" (click)="toggleArticleSort(overview.article_text)" title="Sortierung umschalten">
              <i class="bi" [class.bi-sort-numeric-down]="getArticleSortMode(overview.article_text) === 'count'" 
                       [class.bi-sort-alpha-down]="getArticleSortMode(overview.article_text) === 'price'"></i>
            </button>
          </div>
          <div class="product-info">
            <span class="product-id">{{ overview.product_id }}</span>
            <span class="total-customers">{{ overview.total_customers }} Kunden</span>
            <span *ngIf="hasMultiplePrices(overview)" class="price-variation">
              ±{{ formatPrice(getPriceDifference(overview)) }}
            </span>
            <span class="sort-indicator" *ngIf="overview.price_groups.length > 1">
              <i class="bi bi-info-circle"></i>
              {{ getArticleSortMode(overview.article_text) === 'count' ? 'Sortiert nach Kundenanzahl' : 'Sortiert nach Preis' }}
            </span>
          </div>
        </div>

        <div class="price-groups">
          <div *ngFor="let group of getSortedPriceGroups(overview)" class="price-group">
            <div class="price-info-header" (click)="toggleArticleExpansion(overview.article_text + '-' + group.price)">
              <div class="price-info">
                <span class="price-value">{{ formatPrice(group.price) }}</span>
                <span class="price-count">{{ group.count }} Kunde(n)</span>
              </div>
              <i class="bi" [class.bi-chevron-down]="!isArticleExpanded(overview.article_text + '-' + group.price)" 
                           [class.bi-chevron-up]="isArticleExpanded(overview.article_text + '-' + group.price)"></i>
            </div>
            <div class="customers-details-list" *ngIf="isArticleExpanded(overview.article_text + '-' + group.price)">
              <div *ngFor="let customer of group.customers" class="customer-detail-item"
                   (click)="navigateToCustomer(customer, { product_id: overview.product_id, article_text: overview.article_text })">
                <div class="customer-number">{{ customer }}</div>
                <div class="customer-company" *ngIf="getCustomerDetail(customer)?.last_name_company">
                  {{ getCustomerDetail(customer)?.last_name_company }}
                </div>
                <div class="customer-city" *ngIf="getCustomerDetail(customer)?.city">
                  {{ getCustomerDetail(customer)?.city }}
                </div>
                <div class="invoice-details" *ngIf="getInvoiceInfoForCustomer(customer, group)">
                  <div class="invoice-number">
                    <i class="bi bi-receipt"></i> #{{ getInvoiceInfoForCustomer(customer, group)?.invoice_id }}
                  </div>
                  <div class="invoice-date">
                    <i class="bi bi-calendar3"></i> {{ formatInvoiceDate(getInvoiceInfoForCustomer(customer, group)?.invoice_date || '') }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && !error && filteredProductOverviews.length === 0" class="empty-state">
    <div class="empty-icon">
      <i class="bi bi-search"></i>
    </div>
    <h3>Keine Kundenpreise angezeigt</h3>
    <p *ngIf="searchTerm">
      Keine Artikel entsprechen Ihren Suchkriterien.
    </p>
    <p *ngIf="!searchTerm">
      Geben Sie einen Suchbegriff ein, um Kundenpreise zu finden.<br>
      Sie können nach Artikel-ID, Beschreibung, Kundennummer oder Preis suchen.
    </p>
  </div>
</div>

<!-- Customer Details Modal -->
@if (showCustomerModal) {
<div class="customer-modal-overlay" (click)="closeCustomerModal()">
  <div class="customer-modal-content" (click)="$event.stopPropagation()">
    <div class="customer-modal-header">
      <h2>Kundendetails</h2>
      <button class="close-customer-modal" (click)="closeCustomerModal()">
        <i class="bi bi-x"></i>
      </button>
    </div>
    
    <div class="customer-modal-body">
      @if (isLoadingCustomer) {
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>Lade Kundendetails...</p>
        </div>
      } @else if (customerError) {
        <div class="error-container">
          <p class="error-message">{{ customerError }}</p>
          <button (click)="closeCustomerModal()" class="retry-btn">Schließen</button>
        </div>
      } @else if (selectedCustomer) {
        <div class="customer-details">
          <div class="customer-info-section">
            <h3>Kundeninformationen</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Kundennummer:</span>
                <span class="detail-value">{{ selectedCustomer.customer_number || '-' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Firmenname:</span>
                <span class="detail-value">{{ selectedCustomer.last_name_company || '-' }}</span>
              </div>
              @if (selectedCustomer.name_addition) {
                <div class="detail-item">
                  <span class="detail-label">Namenszusatz:</span>
                  <span class="detail-value">{{ selectedCustomer.name_addition }}</span>
                </div>
              }
              @if (selectedCustomer.email) {
                <div class="detail-item">
                  <span class="detail-label">E-Mail:</span>
                  <span class="detail-value">{{ selectedCustomer.email }}</span>
                </div>
              }
            </div>
          </div>
          
          <div class="customer-address-section">
            <h3>Adressinformationen</h3>
            <div class="detail-grid">
              @if (selectedCustomer.street || selectedCustomer.house_number) {
                <div class="detail-item">
                  <span class="detail-label">Straße:</span>
                  <span class="detail-value">{{ selectedCustomer.street }} {{ selectedCustomer.house_number || '' }}</span>
                </div>
              }
              @if (selectedCustomer.postal_code || selectedCustomer.city) {
                <div class="detail-item">
                  <span class="detail-label">Ort:</span>
                  <span class="detail-value">{{ selectedCustomer.postal_code }} {{ selectedCustomer.city }}</span>
                </div>
              }
              @if (selectedCustomer._country_code) {
                <div class="detail-item">
                  <span class="detail-label">Land:</span>
                  <span class="detail-value">{{ selectedCustomer._country_code }}</span>
                </div>
              }
            </div>
          </div>
          
          @if (selectedCustomerInvoices.length > 0 && selectedProductContext) {
            <div class="customer-invoices-section">
              <h3>Rechnungsinformationen für Artikel</h3>
              <div class="article-context">
                <span class="article-id">{{ selectedProductContext.product_id }}</span>
                <span class="article-text">{{ selectedProductContext.article_text }}</span>
              </div>
              <div class="invoices-list">
                @for (invoice of selectedCustomerInvoices; track invoice.invoice_id) {
                  <div class="invoice-item">
                    <div class="invoice-header">
                      <span class="invoice-number">Rechnung #{{ invoice.invoice_id }}</span>
                      <span class="invoice-date">{{ formatInvoiceDate(invoice.invoice_date) }}</span>
                    </div>
                    <div class="invoice-details">
                      <div class="invoice-article">
                        <span class="article-price">{{ formatPrice(invoice.price) }}</span>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>
</div>
}
