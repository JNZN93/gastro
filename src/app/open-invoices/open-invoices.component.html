<div class="open-invoices-dashboard" (scroll)="onScroll($event)">
  <!-- Header Section -->
  <div class="dashboard-header" [class.scrolled]="isScrolled">
    <div class="header-content">
      <h1 class="dashboard-title" [class.hidden]="isScrolled">
        <svg class="dashboard-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
        </svg>
        Eingehende Rechnungen
      </h1>
      <div class="header-actions">
        <button class="back-button" (click)="goBack()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Zurück
        </button>
        <button class="add-invoice-btn" (click)="addNewInvoiceRow()">
          <svg class="add-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Rechnung hinzufügen
        </button>
      </div>
    </div>
  </div>

  <!-- Navigation Info -->
  <div class="nav-info">
    <div class="nav-hint">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 0 0 1 18 0z"/>
      </svg>
      <span><strong>Tab:</strong> Zwischen Feldern navigieren • <strong>Enter:</strong> Nächste Zeile • <strong>Pfeiltasten:</strong> Navigation</span>
    </div>
  </div>

  <!-- Invoices Section -->
  <div class="invoices-section">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="loading-spinner">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        <span>Rechnungen werden geladen...</span>
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage && !isLoading" class="error-container">
      <div class="error-message">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span>{{ errorMessage }}</span>
        <button (click)="loadInvoices()" class="retry-btn">Erneut versuchen</button>
      </div>
    </div>

    <!-- Content -->
    <div *ngIf="!isLoading && !errorMessage">
      <div class="section-header">
        <h2 class="section-title">Rechnungsübersicht</h2>
        <div class="table-controls">
          <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" placeholder="Suchen..." [(ngModel)]="searchTerm" class="search-input">
          </div>
          <div class="export-buttons">
            <button class="export-btn export-btn-view" (click)="exportToPDF(false)">
              <svg class="export-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <span class="btn-text-full">Als PDF exportieren (Ansicht)</span>
              <span class="btn-text-short">PDF (Ansicht)</span>
            </button>
            <button class="export-btn export-btn-all" (click)="exportToPDF(true)">
              <svg class="export-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <span class="btn-text-full">Als PDF exportieren (Alle)</span>
              <span class="btn-text-short">PDF (Alle)</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <div class="tabs-container">
          <button class="tab-button"
                  [class.active]="activeTab === 'all'"
                  (click)="switchTab('all')">
            <span class="tab-label">Alle</span>
            <span class="tab-count">{{ getTabStats('all').count }}</span>
          </button>
          <button class="tab-button"
                  [class.active]="activeTab === 'open'"
                  (click)="switchTab('open')">
            <span class="tab-label">Offen</span>
            <span class="tab-count">{{ getTabStats('open').count }}</span>
          </button>
          <button class="tab-button"
                  [class.active]="activeTab === 'paid'"
                  (click)="switchTab('paid')">
            <span class="tab-label">Bezahlt</span>
            <span class="tab-count">{{ getTabStats('paid').count }}</span>
          </button>
          <button class="tab-button"
                  [class.active]="activeTab === 'overdue'"
                  (click)="switchTab('overdue')">
            <span class="tab-label">Überfällig</span>
            <span class="tab-count">{{ getTabStats('overdue').count }}</span>
          </button>
          <button class="tab-button"
                  [class.active]="activeTab === 'sepa'"
                  (click)="switchTab('sepa')">
            <span class="tab-label">SEPA</span>
            <span class="tab-count">{{ getTabStats('sepa').count }}</span>
          </button>
        </div>
      </div>

    <!-- Desktop Table View -->
    <div class="table-container desktop-view">
      <table class="invoices-table">
        <thead>
          <tr>
            <th class="sortable-header" (click)="sortBySupplier()">
              <span class="header-text">Lieferant</span>
              <span class="sort-icon">{{ getSortIcon() }}</span>
            </th>
            <th>Rechnungsnummer</th>
            <th>Datum</th>
            <th>Fälligkeitsdatum</th>
            <th>Betrag</th>
            <th>Status</th>
            <th>Anhang</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody>
          <!-- New Invoice Row (shown when adding) -->
          <tr *ngIf="newInvoiceRow" class="invoice-row new-invoice-row" [class]="getRowClass(newInvoiceRow)">
            <!-- Supplier Name -->
            <td class="invoice-cell">
              <input type="text"
                     [(ngModel)]="newInvoiceRow.supplier_name"
                     class="editable-input"
                     placeholder="Lieferant">
            </td>

            <!-- Invoice Number -->
            <td class="invoice-cell">
              <input type="text"
                     [(ngModel)]="newInvoiceRow.invoice_number"
                     class="editable-input"
                     placeholder="Rechnungsnummer">
            </td>

            <!-- Date -->
            <td class="invoice-cell">
              <input type="date"
                     [(ngModel)]="newInvoiceRow.date"
                     class="editable-input"
                     (input)="onDateInput($event, 'new', 'date')">
            </td>

            <!-- Due Date -->
            <td class="invoice-cell">
              <input type="date"
                     [(ngModel)]="newInvoiceRow.due_date"
                     class="editable-input"
                     (input)="onDateInput($event, 'new', 'due_date')">
            </td>

            <!-- Amount -->
            <td class="invoice-cell">
              <input type="number"
                     step="0.01"
                     [(ngModel)]="newInvoiceRow.amount"
                     class="editable-input"
                     placeholder="0.00"
                     (input)="onAmountInput($event, 'new')">
            </td>

            <!-- Status -->
            <td class="status-cell">
              <select [(ngModel)]="newInvoiceRow.status"
                      class="status-select"
                      [class]="getStatusClass(newInvoiceRow.status)"
                      (change)="updateInvoiceFieldLocally(newInvoiceRow, 'status', $any($event.target).value)">
                <option value="open">Offen</option>
                <option value="paid">Bezahlt</option>
                <option value="sepa">SEPA</option>
                <option value="overdue">Überfällig</option>
              </select>
            </td>

            <!-- Anhang: File Upload for new invoice (only one Anhang column) -->
            <td class="attachment-cell">
              <div class="attachment-info">
                <div class="upload-section">
                  <input type="file" [id]="'new-invoice-file'" accept=".pdf,.jpg,.jpeg,.png" class="hidden-file-input" (change)="onNewInvoiceFileSelected($event)" />
                  <button class="upload-row-btn" (click)="triggerNewInvoiceFileInput()" [disabled]="isCreatingInvoice" title="Datei für neue Rechnung auswählen (wird automatisch zu HiDrive hochgeladen)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="upload-icon">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                    <span [title]="newInvoiceRow.file ? newInvoiceRow.file.name : 'Datei wählen (Auto HiDrive)'" style="display:inline-block; max-width: 50px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; vertical-align:middle;">
                      {{ newInvoiceRow.file ? newInvoiceRow.file.name : 'Datei wählen (Auto HiDrive)' }}
                    </span>
                  </button>
                  <button *ngIf="newInvoiceRow?.file" class="remove-file-btn" (click)="removeNewInvoiceFile()" title="Datei entfernen" type="button" style="background:transparent;border:none;padding:0;margin-left:4px;display:inline-flex;align-items:center;cursor:pointer;">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#ef4444" class="remove-icon">
                      <circle cx="12" cy="12" r="9" stroke-width="2"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9l6 6M15 9l-6 6"/>
                    </svg>
                  </button>
                </div>
              </div>
            </td>

            <!-- Actions (Save/Cancel) -->
            <td class="actions-cell">

              <div class="new-invoice-buttons">
                <button class="save-btn" (click)="saveNewInvoice()" [disabled]="isCreatingInvoice">
                  <svg *ngIf="!isCreatingInvoice" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  <svg *ngIf="isCreatingInvoice" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon spinning">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                  </svg>
                  {{ isCreatingInvoice ? 'Speichern...' : 'Speichern' }}
                </button>
                <button class="cancel-btn" (click)="cancelNewInvoice()" [disabled]="isCreatingInvoice">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                  Abbrechen
                </button>
              </div>
            </td>
          </tr>

          <!-- Existing Invoice Rows -->
          <tr *ngFor="let invoice of filteredInvoices; let i = index; trackBy: trackByInvoiceId"
              class="invoice-row" [class]="getRowClass(invoice)">
            <!-- Supplier Name -->
            <td class="invoice-cell">
              <span *ngIf="!isInvoiceEditing(invoice)" class="display-text">{{ invoice.supplier_name }}</span>
              <input *ngIf="isInvoiceEditing(invoice)" type="text"
                     [(ngModel)]="invoice.supplier_name"
                     class="editable-input"
                     placeholder="Lieferant"
                     (input)="updateInvoiceFieldLocally(invoice, 'supplier_name', $any($event.target).value)">
            </td>

            <!-- Invoice Number -->
            <td class="invoice-cell">
              <span *ngIf="!isInvoiceEditing(invoice)" class="display-text">{{ invoice.invoice_number }}</span>
              <input *ngIf="isInvoiceEditing(invoice)" type="text"
                     [(ngModel)]="invoice.invoice_number"
                     class="editable-input"
                     placeholder="Rechnungsnummer"
                     (input)="updateInvoiceFieldLocally(invoice, 'invoice_number', $any($event.target).value)">
            </td>

            <!-- Date -->
            <td class="invoice-cell">
              <span *ngIf="!isInvoiceEditing(invoice)" class="display-text">{{ formatDate(invoice.date) }}</span>
              <input *ngIf="isInvoiceEditing(invoice)" type="date"
                     [(ngModel)]="invoice.date"
                     class="editable-input"
                     (input)="onDateInput($event, invoice, 'date')"
                     (blur)="onDateBlur($event, invoice, 'date')">
            </td>

            <!-- Due Date -->
            <td class="invoice-cell">
              <span *ngIf="!isInvoiceEditing(invoice)" class="display-text">{{ formatDate(invoice.due_date) }}</span>
              <input *ngIf="isInvoiceEditing(invoice)" type="date"
                     [(ngModel)]="invoice.due_date"
                     class="editable-input"
                     (input)="onDateInput($event, invoice, 'due_date')"
                     (blur)="onDateBlur($event, invoice, 'due_date')">
            </td>

            <!-- Amount -->
            <td class="invoice-cell">
              <span *ngIf="!isInvoiceEditing(invoice)" class="display-text">{{ formatCurrency(invoice.amount) }}</span>
              <input *ngIf="isInvoiceEditing(invoice)" type="number"
                     step="0.01"
                     [(ngModel)]="invoice.amount"
                     class="editable-input"
                     placeholder="0.00"
                     (input)="updateInvoiceFieldLocally(invoice, 'amount', $any($event.target).value)">
            </td>

            <!-- Status -->
            <td class="status-cell">
              <select [(ngModel)]="invoice.status"
                      class="status-select"
                      [class]="getStatusClass(invoice.status)"
                      (change)="confirmStatusChange(invoice, $any($event.target).value)">
                <option value="open">Offen</option>
                <option value="paid">Bezahlt</option>
                <option value="sepa">SEPA</option>
                <option value="overdue">Überfällig</option>
              </select>
            </td>

            <!-- Attachment -->
            <td class="attachment-cell">
              <div class="attachment-info">
                <!-- Hidden file input (always available for upload/replace operations) -->
                <input type="file" [id]="'file-' + i" accept=".pdf,.jpg,.jpeg,.png" class="hidden-file-input" (change)="onFileSelectedForInvoice($event, invoice.id)" />

                <div *ngIf="invoice.file_name" class="file-attached">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="attachment-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                  </svg>
                  <span class="file-name">{{ invoice.file_name }}</span>
                  <button class="download-btn" (click)="downloadInvoiceFile(invoice)" title="Datei herunterladen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="download-icon">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </button>
                </div>
                <div *ngIf="!invoice.file_name" class="upload-section">

                  <!-- Upload Options -->
                  <div class="upload-options-row">
                    <button class="upload-hidrive-btn" (click)="triggerFileInputForHiDrive(i)" [disabled]="isUploadingInvoice === invoice.id || isInvoiceEditing(invoice) || invoice.status !== 'open'" title="Zu HiDrive hochladen (nur offene Rechnungen)">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="upload-icon">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                      </svg>
                      <span>HiDrive</span>
                    </button>

                    <div *ngIf="isUploadingInvoice === invoice.id" class="upload-loading">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="upload-icon spinning">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                      </svg>
                      <span>Wird hochgeladen...</span>
                    </div>
                  </div>
                </div>
              </div>
            </td>

            <!-- Actions -->
            <td class="actions-cell">
              <div class="actions-buttons">
                <!-- Edit Button (shown when not editing) -->
                <button *ngIf="!isInvoiceEditing(invoice)" class="edit-btn"
                        (click)="startEditingInvoice(invoice)"
                        [disabled]="editingInvoiceId && editingInvoiceId !== invoice.id">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                  Bearbeiten
                </button>

                <!-- Delete Button (shown when not editing) -->
                <button *ngIf="!isInvoiceEditing(invoice)" class="delete-btn"
                        (click)="confirmDeleteInvoice(invoice)"
                        [disabled]="editingInvoiceId && editingInvoiceId !== invoice.id">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                  Löschen
                </button>

                <!-- Save/Cancel Buttons (shown when editing) -->
                <div *ngIf="isInvoiceEditing(invoice)" class="edit-buttons">
                  <!-- Overwrite existing HiDrive file (visible only when a HiDrive path exists) -->
                  <button *ngIf="invoice.hidrive_path" class="upload-hidrive-btn" (click)="triggerFileInputForHiDriveOverwrite(i)" [disabled]="isUploadingInvoice === invoice.id" title="Bestehende HiDrive-Datei ersetzen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="upload-icon">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 10v6m0 0l-3-3m3 3l3-3"/>
                    </svg>
                    Ersetzen
                  </button>
                  <button class="save-btn" (click)="saveEditedInvoice(invoice)" [disabled]="isCreatingInvoice">
                    <svg *ngIf="!isCreatingInvoice" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <svg *ngIf="isCreatingInvoice" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon spinning">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    {{ isCreatingInvoice ? 'Speichern...' : 'Speichern' }}
                  </button>
                  <button class="cancel-btn" (click)="cancelEditingInvoice(invoice)" [disabled]="isCreatingInvoice">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Abbrechen
                  </button>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Mobile/Tablet Card View -->
    <div class="cards-container mobile-view">
      <!-- New Invoice Card (shown when adding) -->
      <div *ngIf="newInvoiceRow" class="invoice-card new-invoice-card" [class]="getRowClass(newInvoiceRow)">
        <div class="card-header">
          <div class="card-title">
            <input type="text"
                   [(ngModel)]="newInvoiceRow.supplier_name"
                   class="editable-input supplier-input"
                   placeholder="Lieferant">
          </div>
          <div class="card-status">
            <select [(ngModel)]="newInvoiceRow.status"
                    class="status-select"
                    [class]="getStatusClass(newInvoiceRow.status)"
                    (change)="updateInvoiceFieldLocally(newInvoiceRow, 'status', $any($event.target).value)">
              <option value="open">Offen</option>
              <option value="paid">Bezahlt</option>
              <option value="sepa">SEPA</option>
              <option value="overdue">Überfällig</option>
            </select>
          </div>
        </div>
        
        <div class="card-content">
          <div class="card-row-group">
            <div class="card-row half-width">
              <div class="card-label">Rechnungsnr.:</div>
              <div class="card-value">
                <input type="text"
                       [(ngModel)]="newInvoiceRow.invoice_number"
                       class="editable-input"
                       placeholder="Rechnungsnummer">
              </div>
            </div>
            
            <div class="card-row half-width">
              <div class="card-label">Betrag:</div>
              <div class="card-value">
                <input type="number"
                       step="0.01"
                       [(ngModel)]="newInvoiceRow.amount"
                       class="editable-input"
                       placeholder="0.00"
                       (input)="onAmountInput($event, 'new')">
              </div>
            </div>
          </div>
          
          <div class="card-row-group">
            <div class="card-row half-width">
              <div class="card-label">Datum:</div>
              <div class="card-value">
                <input type="date"
                       [(ngModel)]="newInvoiceRow.date"
                       class="editable-input"
                       (input)="onDateInput($event, 'new', 'date')">
              </div>
            </div>
            
            <div class="card-row half-width">
              <div class="card-label">Fälligkeitsdatum:</div>
              <div class="card-value">
                <input type="date"
                       [(ngModel)]="newInvoiceRow.due_date"
                       class="editable-input"
                       (input)="onDateInput($event, 'new', 'due_date')">
              </div>
            </div>
          </div>
          
          <div class="card-row">
            <div class="card-label">Anhang:</div>
            <div class="card-value">
              <div class="attachment-info">
                <div class="upload-section">
                  <input type="file" [id]="'new-invoice-file-mobile'" accept=".pdf,.jpg,.jpeg,.png" class="hidden-file-input" (change)="onNewInvoiceFileSelected($event)" />
                  <button class="upload-row-btn" (click)="triggerNewInvoiceFileInputMobile()" [disabled]="isCreatingInvoice" title="Datei für neue Rechnung auswählen (wird automatisch zu HiDrive hochgeladen)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="upload-icon">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                    <span [title]="newInvoiceRow.file ? newInvoiceRow.file.name : 'Datei wählen (Auto HiDrive)'" style="display:inline-block; max-width: 50px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; vertical-align:middle;">
                      {{ newInvoiceRow.file ? newInvoiceRow.file.name : 'Datei wählen (Auto HiDrive)' }}
                    </span>
                  </button>
                  <button *ngIf="newInvoiceRow?.file" class="remove-file-btn" (click)="removeNewInvoiceFile()" title="Datei entfernen" type="button" style="background:transparent;border:none;padding:0;margin-left:4px;display:inline-flex;align-items:center;cursor:pointer;">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#ef4444" class="remove-icon">
                      <circle cx="12" cy="12" r="9" stroke-width="2"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9l6 6M15 9l-6 6"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-actions">
          <div class="new-invoice-buttons">
            <button class="save-btn" (click)="saveNewInvoice()" [disabled]="isCreatingInvoice">
              <svg *ngIf="!isCreatingInvoice" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              <svg *ngIf="isCreatingInvoice" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon spinning">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              {{ isCreatingInvoice ? 'Speichern...' : 'Speichern' }}
            </button>
            <button class="cancel-btn" (click)="cancelNewInvoice()" [disabled]="isCreatingInvoice">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
              Abbrechen
            </button>
          </div>
        </div>
      </div>

      <!-- Existing Invoice Cards -->
      <div *ngFor="let invoice of filteredInvoices; let i = index; trackBy: trackByInvoiceId"
           class="invoice-card" [class]="getRowClass(invoice)">
        <div class="card-header">
          <div class="card-title">
            <span *ngIf="!isInvoiceEditing(invoice)" class="display-text">{{ invoice.supplier_name }}</span>
            <input *ngIf="isInvoiceEditing(invoice)" type="text"
                   [(ngModel)]="invoice.supplier_name"
                   class="editable-input supplier-input"
                   placeholder="Lieferant"
                   (input)="updateInvoiceFieldLocally(invoice, 'supplier_name', $any($event.target).value)">
          </div>
          <div class="card-status">
            <select [(ngModel)]="invoice.status"
                    class="status-select"
                    [class]="getStatusClass(invoice.status)"
                    (change)="confirmStatusChange(invoice, $any($event.target).value)">
              <option value="open">Offen</option>
              <option value="paid">Bezahlt</option>
              <option value="sepa">SEPA</option>
              <option value="overdue">Überfällig</option>
            </select>
          </div>
        </div>
        
        <div class="card-content">
          <div class="card-row-group">
            <div class="card-row half-width">
              <div class="card-label">Rechnungsnr.:</div>
              <div class="card-value">
                <span *ngIf="!isInvoiceEditing(invoice)" class="display-text">{{ invoice.invoice_number }}</span>
                <input *ngIf="isInvoiceEditing(invoice)" type="text"
                       [(ngModel)]="invoice.invoice_number"
                       class="editable-input"
                       placeholder="Rechnungsnummer"
                       (input)="updateInvoiceFieldLocally(invoice, 'invoice_number', $any($event.target).value)">
              </div>
            </div>
            
            <div class="card-row half-width">
              <div class="card-label">Betrag:</div>
              <div class="card-value">
                <span *ngIf="!isInvoiceEditing(invoice)" class="display-text">{{ formatCurrency(invoice.amount) }}</span>
                <input *ngIf="isInvoiceEditing(invoice)" type="number"
                       step="0.01"
                       [(ngModel)]="invoice.amount"
                       class="editable-input"
                       placeholder="0.00"
                       (input)="updateInvoiceFieldLocally(invoice, 'amount', $any($event.target).value)">
              </div>
            </div>
          </div>
          
          <div class="card-row-group">
            <div class="card-row half-width">
              <div class="card-label">Datum:</div>
              <div class="card-value">
                <span *ngIf="!isInvoiceEditing(invoice)" class="display-text">{{ formatDate(invoice.date) }}</span>
                <input *ngIf="isInvoiceEditing(invoice)" type="date"
                       [(ngModel)]="invoice.date"
                       class="editable-input"
                       (input)="onDateInput($event, invoice, 'date')"
                       (blur)="onDateBlur($event, invoice, 'date')">
              </div>
            </div>
            
            <div class="card-row half-width">
              <div class="card-label">Fälligkeitsdatum:</div>
              <div class="card-value">
                <span *ngIf="!isInvoiceEditing(invoice)" class="display-text">{{ formatDate(invoice.due_date) }}</span>
                <input *ngIf="isInvoiceEditing(invoice)" type="date"
                       [(ngModel)]="invoice.due_date"
                       class="editable-input"
                       (input)="onDateInput($event, invoice, 'due_date')"
                       (blur)="onDateBlur($event, invoice, 'due_date')">
              </div>
            </div>
          </div>
          
          <div class="card-row">
            <div class="card-label">Anhang:</div>
            <div class="card-value">
              <div class="attachment-info">
                <!-- Hidden file input (always available for upload/replace operations) -->
                <input type="file" [id]="'file-mobile-' + i" accept=".pdf,.jpg,.jpeg,.png" class="hidden-file-input" (change)="onFileSelectedForInvoice($event, invoice.id)" />

                <div *ngIf="invoice.file_name" class="file-attached">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="attachment-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                  </svg>
                  <span class="file-name">{{ invoice.file_name }}</span>
                  <button class="download-btn" (click)="downloadInvoiceFile(invoice)" title="Datei herunterladen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="download-icon">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </button>
                </div>
                <div *ngIf="!invoice.file_name" class="upload-section">
                  <!-- Upload Options -->
                  <div class="upload-options-row">
                    <button class="upload-hidrive-btn" (click)="triggerFileInputForHiDriveMobile(i)" [disabled]="isUploadingInvoice === invoice.id || isInvoiceEditing(invoice) || invoice.status !== 'open'" title="Zu HiDrive hochladen (nur offene Rechnungen)">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="upload-icon">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                      </svg>
                      <span>HiDrive</span>
                    </button>

                    <div *ngIf="isUploadingInvoice === invoice.id" class="upload-loading">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="upload-icon spinning">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                      </svg>
                      <span>Wird hochgeladen...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-actions">
          <div class="actions-buttons">
            <!-- Edit Button (shown when not editing) -->
            <button *ngIf="!isInvoiceEditing(invoice)" class="edit-btn"
                    (click)="startEditingInvoice(invoice)"
                    [disabled]="editingInvoiceId && editingInvoiceId !== invoice.id">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              Bearbeiten
            </button>

            <!-- Delete Button (shown when not editing) -->
            <button *ngIf="!isInvoiceEditing(invoice)" class="delete-btn"
                    (click)="confirmDeleteInvoice(invoice)"
                    [disabled]="editingInvoiceId && editingInvoiceId !== invoice.id">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              Löschen
            </button>

            <!-- Save/Cancel Buttons (shown when editing) -->
            <div *ngIf="isInvoiceEditing(invoice)" class="edit-buttons">
              <!-- Overwrite existing HiDrive file (visible only when a HiDrive path exists) -->
              <button *ngIf="invoice.hidrive_path" class="upload-hidrive-btn" (click)="triggerFileInputForHiDriveOverwriteMobile(i)" [disabled]="isUploadingInvoice === invoice.id" title="Bestehende HiDrive-Datei ersetzen">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="upload-icon">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 10v6m0 0l-3-3m3 3l3-3"/>
                </svg>
                Ersetzen
              </button>
              <button class="save-btn" (click)="saveEditedInvoice(invoice)" [disabled]="isCreatingInvoice">
                <svg *ngIf="!isCreatingInvoice" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                <svg *ngIf="isCreatingInvoice" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon spinning">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                {{ isCreatingInvoice ? 'Speichern...' : 'Speichern' }}
              </button>
              <button class="cancel-btn" (click)="cancelEditingInvoice(invoice)" [disabled]="isCreatingInvoice">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Abbrechen
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Summary Stats -->
    <div class="summary-stats">
      <div class="stat-item">
        <span class="stat-label">
          {{ activeTab === 'all' ? 'Gesamt Rechnungen:' : activeTab === 'open' ? 'Offene Rechnungen:' : activeTab === 'paid' ? 'Bezahlte Rechnungen:' : activeTab === 'overdue' ? 'Überfällige Rechnungen:' : 'SEPA Rechnungen:' }}
        </span>
        <span class="stat-value">{{ filteredInvoices.length }}</span>
      </div>
      <div class="stat-item" *ngIf="activeTab === 'all'">
        <span class="stat-label">Offene Rechnungen:</span>
        <span class="stat-value">{{ openInvoicesCount }}</span>
      </div>
      <div class="stat-item" *ngIf="activeTab === 'all'">
        <span class="stat-label">Überfällig:</span>
        <span class="stat-value">{{ overdueInvoicesCount }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">
          {{ activeTab === 'all' ? 'Gesamtbetrag offen:' : 'Gesamtbetrag:' }}
        </span>
        <span class="stat-value">{{ formatCurrency(getTabStats(activeTab).amount) }}</span>
      </div>
    </div>
  </div>

  <!-- Duplicate Invoice Warning Modal -->
  <div class="modal-overlay" [class.active]="showDuplicateModal" (click)="cancelDuplicateCreation()"></div>
  <div class="duplicate-modal" [class.active]="showDuplicateModal">
    <div class="modal-header">
      <h2>⚠️ Rechnungsnummer existiert bereits</h2>
      <button class="close-btn" (click)="cancelDuplicateCreation()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="modal-content">
      <p class="warning-text">
        Die Rechnungsnummer <strong>{{ pendingInvoiceData?.invoice_number }}</strong> existiert bereits.
        Sind Sie sicher, dass Sie diese Rechnung trotzdem erstellen möchten?
      </p>
      
      <div class="existing-invoices">
        <h3>Bestehende Rechnungen mit dieser Nummer:</h3>
        <div class="invoice-list">
          <div *ngFor="let invoice of duplicateInvoices" class="duplicate-invoice-item">
            <div class="invoice-info">
              <div class="info-row">
                <span class="label">Lieferant:</span>
                <span class="value">{{ invoice.supplier_name }}</span>
              </div>
              <div class="info-row">
                <span class="label">Rechnungsnr.:</span>
                <span class="value">{{ invoice.invoice_number }}</span>
              </div>
              <div class="info-row">
                <span class="label">Datum:</span>
                <span class="value">{{ formatDate(invoice.date) }}</span>
              </div>
              <div class="info-row">
                <span class="label">Betrag:</span>
                <span class="value">{{ formatCurrency(invoice.amount) }}</span>
              </div>
              <div class="info-row">
                <span class="label">Status:</span>
                <span class="value" [class]="'status-badge ' + getStatusClass(invoice.status)">
                  {{ invoice.status === 'open' ? 'Offen' : 
                     invoice.status === 'paid' ? 'Bezahlt' : 
                     invoice.status === 'sepa' ? 'SEPA' : 
                     invoice.status === 'overdue' ? 'Überfällig' : invoice.status }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="cancel-btn" (click)="cancelDuplicateCreation()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Abbrechen
        </button>
        <button class="confirm-btn" (click)="confirmCreateDespiteDuplicates()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="btn-icon">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          Trotzdem erstellen
        </button>
      </div>
    </div>
  </div>

</div>
