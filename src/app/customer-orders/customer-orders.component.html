<div class="article-container">

  <div class="content">
    <!-- Hauptbereich mit zwei Spalten -->
    <div class="main-content">
      <!-- Linke Spalte: Auftrag -->
      <div class="order-column">
        @if (globalService.selectedCustomerForOrders) {
        <div class="order-section">
          <div class="order-header">
            <h3>Auftrag für {{ globalService.selectedCustomerForOrders.last_name_company || globalService.selectedCustomerForOrders.customer_number }}</h3>
            <button (click)="openCustomerModal()" class="change-customer-btn">
              <span class="material-icons">swap_horiz</span>
              Kunde wechseln
            </button>
          </div>
          
          <!-- Kunden-Info-Box -->
          <div class="customer-info-box">
            <div class="customer-details">
              <div class="customer-basic-info">
                <h4>{{ globalService.selectedCustomerForOrders.last_name_company || globalService.selectedCustomerForOrders.customer_number }}</h4>
                @if (globalService.selectedCustomerForOrders.name_addition) {
                  <p class="customer-addition">{{ globalService.selectedCustomerForOrders.name_addition }}</p>
                }
                @if (globalService.selectedCustomerForOrders.city) {
                  <p class="customer-location">{{ globalService.selectedCustomerForOrders.city }}</p>
                }
              </div>
              <div class="customer-pricing-info">
                @if (customerArticlePrices.length > 0) {
                  <div class="pricing-status success" (click)="openArticlePricesModal()" style="cursor: pointer;">
                    <span class="material-icons">check_circle</span>
                    <span>{{ customerArticlePrices.length }} kundenspezifische Preise verfügbar</span>
                    <span class="material-icons click-hint">open_in_new</span>
                  </div>
                } @else {
                  <div class="pricing-status standard" (click)="openArticlePricesModal()" style="cursor: pointer;">
                    <span class="material-icons">info</span>
                    <span>Standard-Preise werden verwendet</span>
                    <span class="material-icons click-hint">open_in_new</span>
                  </div>
                }
              </div>
            </div>
            <button (click)="clearSelectedCustomer()" class="clear-customer-btn" title="Kunde entfernen">
              <span class="material-icons">close</span>
            </button>
          </div>
          
          @if (orderItems.length > 0) {
          <div class="order-table-container">
            <table class="order-table">
              <thead>
                <tr>
                  <th>Pos.</th>
                  <th>Artikel</th>
                  <th>Art.-Nr.</th>
                  <th>Menge</th>
                  <th>Kundenpreis (€)</th>
                  <th>Gesamtpreis (€)</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody>
                @for (item of orderItems; track $index; let i = $index) {
                <tr class="order-row">
                  <td class="position">{{ i + 1 }}</td>
                  <td class="article-name">{{ item.article_text }}</td>
                  <td class="article-number">{{ item.article_number }}</td>
                  <td class="quantity">
                    <input type="number" [(ngModel)]="item.quantity" min="1" class="quantity-edit" (change)="updateItemTotal(item)">
                  </td>
                  <td class="customer-price">
                    <input type="number" 
                           [(ngModel)]="item.different_price" 
                           step="0.01" 
                           min="0" 
                           class="price-edit" 
                           (change)="updateItemTotal(item)"
                           [placeholder]="item.sale_price">
                  </td>
                  <td class="total-price">€{{ (getItemPrice(item) * item.quantity).toFixed(2) }}</td>
                  <td class="actions">
                    <button (click)="removeFromOrder(i)" class="remove-btn" title="Entfernen">
                      <span class="material-icons">delete</span>
                    </button>
                  </td>
                </tr>
                }
              </tbody>
              <tfoot>
                <tr class="order-total-row">
                  <td colspan="5" class="total-label"><strong>Gesamt:</strong></td>
                  <td class="total-amount"><strong>€{{ getOrderTotal().toFixed(2) }}</strong></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
            
            <div class="order-actions">
              <button (click)="saveOrder()" class="save-order-btn">
                <span class="material-icons">save</span>
                Auftrag speichern
              </button>
              <button (click)="clearOrder()" class="clear-order-btn">
                <span class="material-icons">clear</span>
                Auftrag löschen
              </button>
            </div>
          </div>
          } @else {
          <div class="no-items">
            <p>Noch keine Artikel im Auftrag. Suchen Sie nach Artikeln und fügen Sie sie hinzu.</p>
          </div>
          }
        </div>
        } @else {
        <div class="no-customer-selected">
          <h3>Auftragserstellung</h3>
          <p>Bitte wählen Sie zuerst einen Kunden aus, um einen Auftrag zu erstellen.</p>
          <button (click)="openCustomerModal()" class="select-customer-btn">
            <span class="material-icons">people</span>
            Kunde auswählen
          </button>
        </div>
        }
      </div>

      <!-- Rechte Spalte: Artikelauswahl -->
      <div class="articles-column">
        <div class="articles-section">
          <h3>Artikelauswahl</h3>
          
          <div class="search-container">
            <div class="search-input-wrapper">
              <input type="text" [(ngModel)]="searchTerm" (input)="filteredArtikelData()" (keydown.enter)="addFirstFilteredArticle()" placeholder="Artikel suchen..."
                class="search-input">
              <button *ngIf="searchTerm" (click)="clearSearch()" class="clear-search">
                <span class="material-icons">close</span>
              </button>
            </div>
            <button (click)="startScanner()" [disabled]="isScanning" class="scanner-btn">
              <span class="material-symbols-outlined">barcode</span>
            </button>
          </div>
          
          @if (searchTerm && filteredArtikels.length > 0) {
          <div class="articles-list">
            @for (artikel of filteredArtikels; track $index) {
            <div class="article-list-item">
              <div class="article-info">
                <div class="article-details">
                  <h4 class="article-title">{{ artikel.article_text }}</h4>
                  <p class="article-number">Art.-Nr: {{ artikel.article_number }}</p>
                  <p class="article-price">
                    @if (artikel.different_price !== undefined) {
                      <span class="customer-price">€{{ artikel.different_price }}</span>
                      <span class="original-price">(Standard: €{{ artikel.sale_price }})</span>
                    } @else {
                      <span class="standard-price">€{{ artikel.sale_price }}</span>
                    }
                  </p>
                </div>
                <div class="article-actions">
                  <input type="number" [(ngModel)]="artikel.quantity" placeholder="Menge" class="quantity-input" min="1">
                  <button (click)="addToOrder($event, artikel)" class="add-to-order-btn">
                    <span class="material-icons">add_shopping_cart</span>
                  </button>
                </div>
              </div>
            </div>
            }
          </div>
          } @else if (!searchTerm) {
          <div class="no-search">
            <p>Geben Sie einen Suchbegriff ein, um Artikel zu finden.</p>
          </div>
          } @else {
          <div class="no-results">
            <p>Keine Artikel für "{{ searchTerm }}" gefunden.</p>
          </div>
          }
        </div>
      </div>
    </div>
  </div>

</div>

@if (isVisible) {
<app-upload-loading></app-upload-loading>
}

<!-- Scanner Modal -->
<div class="scanner-modal" *ngIf="isScanning">
  <select [(ngModel)]="selectedDevice">
    <option *ngFor="let device of availableDevices" [ngValue]="device">
      {{ device.label }}
    </option>
  </select>
  <div class="scanner-content">
    <button class="close-scanner" (click)="stopScanner()">
      <span class="material-icons">close</span>
    </button>
    <div class="scanner-wrapper">
      <zxing-scanner #scanner 
      [device]="selectedDevice"
      [videoConstraints]="videoConstraints"
      [tryHarder]="true"
      [formats]="formatsEnabled"
      [torch]="true"
      (scanSuccess)="onCodeResult($event)">
      </zxing-scanner>
    </div>
  </div>
</div>

<!-- Article Prices Modal -->
<div class="article-prices-modal" *ngIf="isArticlePricesModalOpen">
  <div class="article-prices-modal-content">
    <div class="article-prices-modal-header">
      <h2>Artikel-Preise</h2>
      <button class="close-article-prices-modal" (click)="closeArticlePricesModal()">
        <span class="material-icons">close</span>
      </button>
    </div>
    
    <div class="article-prices-modal-body">
      <div class="article-prices-search">
        <input type="text" [(ngModel)]="articlePricesSearchTerm" (input)="filterArticlePrices()" placeholder="Artikel suchen..." class="article-prices-search-input">
      </div>
      
      <div class="article-prices-table-container">
        <table class="article-prices-table">
          <thead>
            <tr>
              <th>Artikel</th>
              <th>Art.-Nr.</th>
              <th>Kundenpreis (€)</th>
              <th>Rechnungs-ID</th>
              <th>Rechnungsdatum</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody>
            @for (customerPrice of filteredArticlePrices; track customerPrice.product_id) {
            <tr class="article-price-row">
              <td class="article-name">{{ customerPrice.article_text || 'Unbekannter Artikel' }}</td>
              <td class="article-number">{{ customerPrice.article_number || customerPrice.product_id }}</td>
              <td class="customer-price">
                <span class="customer-price-value">€{{ customerPrice.unit_price_net }}</span>
              </td>
              <td class="invoice-id">{{ customerPrice.invoice_id || '-' }}</td>
              <td class="invoice-date">{{ formatInvoiceDate(customerPrice.invoice_date) }}</td>
              <td class="action">
                <button (click)="addArticleFromPricesModal(customerPrice)" class="add-article-btn" title="Zum Auftrag hinzufügen">
                  <span class="material-icons">add_shopping_cart</span>
                </button>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      
      @if (filteredArticlePrices.length === 0) {
      <div class="no-article-prices">
        <p>Keine Artikel gefunden.</p>
      </div>
      }
    </div>
  </div>
</div>

<!-- Customer Modal -->
<div class="customer-modal" *ngIf="isCustomerModalOpen">
  <div class="customer-modal-content">
    <div class="customer-modal-header">
      <h2>Kundenliste</h2>
      <button class="close-customer-modal" (click)="closeCustomerModal()">
        <span class="material-icons">close</span>
      </button>
    </div>
    
    <div class="customer-modal-body">
      <div class="customer-search">
        <input type="text" [(ngModel)]="customerSearchTerm" (input)="filterCustomers()" placeholder="Kunden suchen..." class="customer-search-input">
      </div>
      
      <div class="customers-grid">
        @for (customer of filteredCustomers; track customer.id) {
        <div class="customer-card">
          <div class="customer-card-header">
            <h3>{{ customer.customer_number }}</h3>
          </div>
          <div class="customer-card-body">
            <p class="customer-name"><strong>{{ customer.last_name_company || 'Kein Name' }}</strong></p>
            <p class="customer-addition" *ngIf="customer.name_addition">{{ customer.name_addition }}</p>
            <p class="customer-city" *ngIf="customer.city">{{ customer.city }}</p>
            <p class="customer-email" *ngIf="customer.email">{{ customer.email }}</p>
          </div>
          <div class="customer-card-footer">
            <button class="select-customer-btn" (click)="selectCustomer(customer)">
              <span class="material-icons">check</span>
              Auswählen
            </button>
          </div>
        </div>
        }
      </div>
      
      @if (isLoadingCustomers) {
      <div class="customer-loading">
        <div class="loader"></div>
        <p>Kunden werden geladen...</p>
      </div>
      }
      
      @if (!isLoadingCustomers && filteredCustomers.length === 0) {
      <div class="no-customers">
        <p>Keine Kunden gefunden.</p>
      </div>
      }
    </div>
  </div>
</div>
